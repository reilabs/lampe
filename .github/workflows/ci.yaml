name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-ci-image:
    uses: ./.github/workflows/build-ci-image.yaml
    with:
      allow_push: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
  
  ensure-noir-version:
    name: Check Noir Versions
    needs: build-ci-image
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v6
      - name: Check Noir Version Consistency
        run: scripts/check_noir_version_consistency.xsh

  build-lean:
    name: Build Lampe
    needs: build-ci-image
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Current Branch (Sparse)
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            Lampe
            stdlib/lampe/lean-toolchain
            stdlib/lampe/lake-manifest.json
      - name: Set Lake Package Dir
        run: |
          mkdir -p "$RUNNER_TEMP/lake-packages"
          echo "LAKE_PKG_DIR=$RUNNER_TEMP/lake-packages" >> "$GITHUB_ENV"
      - name: Restore Lake Packages Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.LAKE_PKG_DIR }}
          key: lake-packages-${{ runner.os }}-${{ hashFiles('Lampe/lean-toolchain', 'Lampe/lake-manifest.json', 'stdlib/lampe/lean-toolchain', 'stdlib/lampe/lake-manifest.json') }}
          restore-keys: |
            lake-packages-${{ runner.os }}-
      - name: Restore Lampe Build Cache
        uses: actions/cache@v4
        with:
          path: Lampe/.lake/build
          key: lampe-build-${{ runner.os }}-${{ hashFiles('Lampe/lean-toolchain', 'Lampe/lake-manifest.json') }}
          restore-keys: |
            lampe-build-${{ runner.os }}-
      - name: Get Mathlib Cache
        working-directory: Lampe
        run: lake exe cache get
      - name: Make All (Lampe)
        working-directory: Lampe
        run: lake exe mk_all --check --lib Lampe
      - name: Build Lampe
        working-directory: Lampe
        run: lake build
      - name: Test Lampe
        working-directory: Lampe
        run: lake test

  build-rust:
    name: Build CLI
    needs: [build-ci-image, check-rust-formatting, lint-rust, test-rust]
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v6
      - name: Build (Cargo)
        run: cargo build --release
      - name: Upload CLI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lampe-cli-${{ github.sha }}
          path: target/release/lampe

  check-rust-formatting:
    name: Check Rust Formatting
    needs: build-ci-image
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Check Formatting
        run: cargo +nightly fmt --all -- --check

  lint-rust:
    name: Lint Rust
    needs: build-ci-image
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v6
      - name: Lint (Clippy)
        run: RUSTFLAGS="-Dwarnings" cargo clippy --all-targets --all-features

  test-rust:
    name: Test Rust
    needs: build-ci-image
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v6
      - name: Test (Cargo)
        run: cargo test --all
      - name: Remove Build Artifacts
        run: rm -rf target

  build-stdlib:
    name: Build Stdlib
    needs: [build-ci-image, build-rust, build-lean]
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      LAMPE_TEST_CURRENT_COMMIT_SHA: ${{ github.head_ref || github.ref_name }}
      LAMPE_KEEP_LAKE_CACHE: "1"
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v6
      - name: Set Lake Package Dir
        run: |
          mkdir -p "$RUNNER_TEMP/lake-packages"
          echo "LAKE_PKG_DIR=$RUNNER_TEMP/lake-packages" >> "$GITHUB_ENV"
      - name: Restore Lake Packages Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.LAKE_PKG_DIR }}
          key: lake-packages-${{ runner.os }}-${{ hashFiles('Lampe/lean-toolchain', 'Lampe/lake-manifest.json', 'stdlib/lampe/lean-toolchain', 'stdlib/lampe/lake-manifest.json') }}
          restore-keys: |
            lake-packages-${{ runner.os }}-
      - name: Restore Lampe Build Cache
        uses: actions/cache@v4
        with:
          path: Lampe/.lake/build
          key: lampe-build-${{ runner.os }}-${{ hashFiles('Lampe/lean-toolchain', 'Lampe/lake-manifest.json') }}
          restore-keys: |
            lampe-build-${{ runner.os }}-
      - name: Restore Stdlib Build Cache
        uses: actions/cache@v4
        with:
          path: stdlib/lampe/.lake/build
          key: stdlib-build-${{ runner.os }}-${{ hashFiles('stdlib/lampe/lean-toolchain', 'stdlib/lampe/lake-manifest.json') }}
          restore-keys: |
            stdlib-build-${{ runner.os }}-
      - name: Download CLI Artifact
        uses: actions/download-artifact@v4
        with:
          name: lampe-cli-${{ github.sha }}
          path: target/release
      - name: Ensure CLI Executable
        run: chmod +x target/release/lampe
      - name: Test Stdlib Extraction
        run: ./stdlib/test.xsh

  end-to-end:
    name: E2E Tests
    needs: [build-ci-image, build-stdlib]
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      LAMPE_TEST_CURRENT_COMMIT_SHA: ${{ github.head_ref || github.ref_name }}
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v6
      - name: Set Lake Package Dir
        run: |
          mkdir -p "$RUNNER_TEMP/lake-packages"
          echo "LAKE_PKG_DIR=$RUNNER_TEMP/lake-packages" >> "$GITHUB_ENV"
      - name: Restore Lake Packages Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.LAKE_PKG_DIR }}
          key: lake-packages-${{ runner.os }}-${{ hashFiles('Lampe/lean-toolchain', 'Lampe/lake-manifest.json', 'stdlib/lampe/lean-toolchain', 'stdlib/lampe/lake-manifest.json') }}
          restore-keys: |
            lake-packages-${{ runner.os }}-
      - name: Restore Lampe Build Cache
        uses: actions/cache@v4
        with:
          path: Lampe/.lake/build
          key: lampe-build-${{ runner.os }}-${{ hashFiles('Lampe/lean-toolchain', 'Lampe/lake-manifest.json') }}
          restore-keys: |
            lampe-build-${{ runner.os }}-
      - name: Restore Stdlib Build Cache
        uses: actions/cache@v4
        with:
          path: stdlib/lampe/.lake/build
          key: stdlib-build-${{ runner.os }}-${{ hashFiles('stdlib/lampe/lean-toolchain', 'stdlib/lampe/lake-manifest.json') }}
          restore-keys: |
            stdlib-build-${{ runner.os }}-
      - name: Download CLI Artifact
        uses: actions/download-artifact@v4
        with:
          name: lampe-cli-${{ github.sha }}
          path: target/release
      - name: Ensure CLI Executable
        run: chmod +x target/release/lampe
      - name: Run Test Script
        run: ./testing/test.xsh

  examples:
    name: Examples
    needs: [build-ci-image, build-stdlib]
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      LAMPE_TEST_CURRENT_COMMIT_SHA: ${{ github.head_ref || github.ref_name }}
    container:
      image: ghcr.io/reilabs/lampe-ci:${{ needs.build-ci-image.outputs.image_tag }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v6
      - name: Set Lake Package Dir
        run: |
          mkdir -p "$RUNNER_TEMP/lake-packages"
          echo "LAKE_PKG_DIR=$RUNNER_TEMP/lake-packages" >> "$GITHUB_ENV"
      - name: Restore Lake Packages Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.LAKE_PKG_DIR }}
          key: lake-packages-${{ runner.os }}-${{ hashFiles('Lampe/lean-toolchain', 'Lampe/lake-manifest.json', 'stdlib/lampe/lean-toolchain', 'stdlib/lampe/lake-manifest.json') }}
          restore-keys: |
            lake-packages-${{ runner.os }}-
      - name: Restore Lampe Build Cache
        uses: actions/cache@v4
        with:
          path: Lampe/.lake/build
          key: lampe-build-${{ runner.os }}-${{ hashFiles('Lampe/lean-toolchain', 'Lampe/lake-manifest.json') }}
          restore-keys: |
            lampe-build-${{ runner.os }}-
      - name: Restore Stdlib Build Cache
        uses: actions/cache@v4
        with:
          path: stdlib/lampe/.lake/build
          key: stdlib-build-${{ runner.os }}-${{ hashFiles('stdlib/lampe/lean-toolchain', 'stdlib/lampe/lake-manifest.json') }}
          restore-keys: |
            stdlib-build-${{ runner.os }}-
      - name: Download CLI Artifact
        uses: actions/download-artifact@v4
        with:
          name: lampe-cli-${{ github.sha }}
          path: target/release
      - name: Ensure CLI Executable
        run: chmod +x target/release/lampe
      - name: Run Test Script On Examples
        run: ./examples/test.xsh
